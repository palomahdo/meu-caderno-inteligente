<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Caderno Jur√≠dico - Teste de √Åudio</title>
    <style>
        :root { --primary: #1e293b; --accent: #4f46e5; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #334155; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .monitor-box { background: #1e293b; color: #10b981; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; min-height: 100px; margin: 15px 0; border: 3px solid #334155; overflow-y: auto; max-height: 200px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        button { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-start { background: #4f46e5; color: white; }
        .btn-stop { background: #be123c; color: white; width: 100%; display: none; }
        .sidebar { width: 300px; border-right: 1px solid #eee; padding-right: 15px; }
        .main-layout { display: flex; gap: 20px; margin-top: 25px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 style="text-align: center;">‚öñÔ∏è Diagn√≥stico de Transcri√ß√£o</h2>
        
        <p><strong>1. Clique no bot√£o. 2. Selecione a aba da aula. 3. Marque "Compartilhar √°udio".</strong></p>

        <div class="controls">
            <button class="btn-start" onclick="iniciar(false)">üéôÔ∏è Testar Apenas √Åudio</button>
            <button class="btn-start" onclick="iniciar(true)" style="background:#0284c7">üé• Testar √Åudio + V√≠deo</button>
        </div>

        <div class="monitor-box" id="monitor">
            > Aguardando √°udio... (O que o professor falar deve aparecer aqui em tempo real)
        </div>

        <button class="btn-stop" id="stopBtn" onclick="parar()">üõë Parar e Enviar para IA</button>

        <div class="main-layout">
            <div class="sidebar" id="subjectList">
                <h3>üìö Suas Mat√©rias</h3>
            </div>
            <div id="content" style="flex-grow: 1;">
                <h3>üìÑ Resultado da IA</h3>
                <div id="aiResult">Aguardando processamento...</div>
            </div>
        </div>
    </div>

    <script>
        let recognition, transcript = "", mediaRecorder, chunks = [];
        let library = JSON.parse(localStorage.getItem('legal_library') || '{}');

        renderSidebar();

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'pt-BR';

            recognition.onresult = (e) => {
                let current = "";
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    current += e.results[i][0].transcript;
                }
                transcript = current;
                // EXIBI√á√ÉO EM TEMPO REAL NO MONITOR PRETO
                document.getElementById('monitor').innerText = "> ESCUTANDO: " + transcript;
            };
        }

        async function iniciar(video) {
            try {
                // ESTA LINHA √â A CHAVE: Abre a escolha de aba
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                
                if(video) {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, {type: 'video/webm'});
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = "video_aula.webm"; a.click();
                    };
                    mediaRecorder.start();
                }

                recognition.start();
                document.getElementById('stopBtn').style.display = "block";
                document.getElementById('monitor').innerText = "> Conectado! D√™ o play na aula...";
            } catch (err) {
                alert("AVISO: Voc√™ precisa selecionar uma guia e marcar 'Compartilhar √°udio da guia'.");
            }
        }

        function parar() {
            recognition.stop();
            if(mediaRecorder) mediaRecorder.stop();
            processarIA();
        }

        async function processarIA() {
            document.getElementById('aiResult').innerText = "‚è≥ A IA est√° lendo a transcri√ß√£o acima e organizando...";
            try {
                const res = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transcription: transcript })
                });
                const data = await res.json();
                salvar(data.result);
            } catch (e) {
                document.getElementById('aiResult').innerText = "‚ùå Erro na IA. Verifique a chave na Vercel.";
            }
        }

        function salvar(texto) {
            let m = "Direito Geral", s = "Aula " + new Date().toLocaleTimeString();
            const matMatch = texto.match(/MAT√âRIA:\s*(.*)/i);
            const subMatch = texto.match(/SUBTEMA:\s*(.*)/i);
            if(matMatch) m = matMatch[1].trim();
            if(subMatch) s = subMatch[1].trim();

            if(!library[m]) library[m] = {};
            if(!library[m][s]) library[m][s] = [];
            library[m][s].push(texto);
            localStorage.setItem('legal_library', JSON.stringify(library));
            renderSidebar();
            document.getElementById('aiResult').innerHTML = `<pre style="white-space:pre-wrap;">${texto}</pre>`;
        }

        function renderSidebar() {
            const list = document.getElementById('subjectList');
            list.innerHTML = "<h3>üìö Mat√©rias</h3>";
            for (let m in library) {
                let d = document.createElement('div');
                d.style.fontWeight = "bold"; d.style.marginTop = "10px";
                d.innerText = "üìÅ " + m;
                list.appendChild(d);
                for (let s in library[m]) {
                    let i = document.createElement('div');
                    i.style.paddingLeft = "15px"; i.style.cursor = "pointer";
                    i.innerText = "‚îî " + s;
                    i.onclick = () => document.getElementById('aiResult').innerHTML = `<pre style="white-space:pre-wrap;">${library[m][s][0]}</pre>`;
                    list.appendChild(i);
                }
            }
        }
    </script>
</body>
</html>
